---- The Dynamic script gives the NEVM from SMART transaction table for a 6 months period

 SELECT COUNT (DISTINCT acid) count, max_band, cur_band
    FROM (SELECT aa.acid,
                 CASE
                    WHEN max_vol = 1 THEN '01_Poor'
                    WHEN max_vol BETWEEN 2 AND 5 THEN '02_Irregular'
                    WHEN max_vol BETWEEN 6 AND 10 THEN '03_Regular'
                    WHEN max_vol BETWEEN 11 AND 20 THEN '04_Frequent'
                    WHEN max_vol > 20 THEN '05_Daily'
                    WHEN max_vol is null THEN '00_No_Usage'
                 END
                    max_band,
                 CASE
                    WHEN cur_vol = 1 THEN '01_Poor'
                    WHEN cur_vol BETWEEN 2 AND 5 THEN '02_Irregular'
                    WHEN cur_vol BETWEEN 6 AND 10 THEN '03_Regular'
                    WHEN cur_vol BETWEEN 11 AND 20 THEN '04_Frequent'
                    WHEN cur_vol > 20 THEN '05_Daily'
                    WHEN cur_vol is null THEN '00_No_Usage'
                 END
                    cur_band
            FROM    (  ---- Maximum Monthly  Volume within six moth period ---
                       SELECT acid, MAX (vol) max_vol
                         FROM (  SELECT acid,
                                        SUM (TXCOUNT) vol,
                                        TO_CHAR (txdate, 'YYYYMM') mnth
                                   FROM smart_txn
                                  WHERE txdate BETWEEN TO_DATE (
                                                          TO_CHAR (
                                                             (LAST_DAY (
                                                                 ADD_MONTHS (
                                                                    TRUNC (SYSDATE),
                                                                    -6))),
                                                             'yyyymm'),
                                                          'yyyymm')
                                                   AND LAST_DAY (
                                                          ADD_MONTHS (
                                                             TRUNC (SYSDATE),
                                                             -1))
                               GROUP BY acid, TO_CHAR (txdate, 'YYYYMM'))
                     GROUP BY acid) aa
                 LEFT OUTER JOIN
                    (  --- Volume in Current Month --
                       SELECT acid, vol cur_vol -- , mnth
                         FROM (  SELECT acid,
                                        SUM (txcount) vol,
                                        TO_CHAR (txdate, 'YYYYMM') mnth
                                   FROM smart_txn
                                  WHERE txdate BETWEEN TO_DATE (
                                                          TO_CHAR (
                                                             (LAST_DAY (
                                                                 ADD_MONTHS (
                                                                    TRUNC (SYSDATE),
                                                                    -6))),
                                                             'yyyymm'),
                                                          'yyyymm')
                                                   AND LAST_DAY (
                                                          ADD_MONTHS (
                                                             TRUNC (SYSDATE),
                                                             -1))
                               GROUP BY acid, TO_CHAR (txdate, 'YYYYMM'))
                        WHERE mnth =
                                 TO_CHAR (ADD_MONTHS (TRUNC (SYSDATE), -1),
                                          'YYYYMM')
                     -- GROUP BY acid
                     ) bb
                 ON aa.acid = bb.acid)
GROUP BY max_band, cur_band
